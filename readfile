#!/usr/bin/env groovy

def products
def versions_collection
def products_collection

pipeline {
agent { label 'master'}
    parameters 
    {
                  choice(name: 'Deployment_Type', choices:"Release\nDaily Build", description: "Select Deployment Type" )
    }
    stages 
    {
        stage("Select Product and Deployment after that") 
        {
            steps 
            {
                script 
                {
                    if("${params.Deployment_Type}" == "Release")
                    { 
                        def bodyFile = new File("/app/JobRelease/latest_release.txt").readLines()
                        
                        bodyFile.each { line ->
                                         def arr = line.tokenize(':')
                                         def product = arr[0]
                                         def version = arr[1]
                                         println "product : ${product}  version: ${version}" 
                                         build(job: "Deployment",
                                                 parameters:
                                                 [string(name: 'Environment', value: "TEST"),
                                                 string(name: 'Product', value: "${product}"),
                                                 string(name: 'Version', value: "${version}"),
                                        ])
                                          
                        }
                              
                    }
                    else 
                    {
                          dir('/app/JobRelease') 
                          {
                              
                              products_collection = sh (script: 'awk -F ":" \'{print $1}\' latest_release.txt|sort |uniq', returnStdout: true).trim()
                          }
                          products = input message: 'Choose  Product!', ok: 'SET', parameters: [choice(name: 'PRODUCTS', choices: "${products_collection}", description: '')]
              
                          dir('/app/JobRelease') 
                          {
                              def abc = products
                              echo "$abc"
                  
                              sh """ cat latest_release.txt|grep $abc > product.txt """
                              version_collection = sh (script: 'awk \'{print $2}\' FS=: product.txt', returnStdout: true).trim()
                              sh """ rm -rf product.txt """
                          }
                          versions = input message: 'Choose version!', ok: 'SET', parameters: [choice(name: 'VERSION', choices: "${version_collection}", description: '')]                    
                    }                    
                }
            }
        }
    }
}
