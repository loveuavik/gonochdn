#!/usr/bin/env groovy

pipeline {
agent { label 'master'}
    stages {
        stage("Select Product and Version") {
            steps {
                script {
                    
                    def version_collection
                    def products_collection
                    
                    dir('/app/JobRelease') {
                         products_collection = sh (script: 'cat latest_release.txt |awk \'{print $1}\' FS=:', returnStdout: true).trim()
                    }
                    products = input message: 'Choose  Product!', ok: 'SET', parameters: [choice(name: 'PRODUCTS', choices: "${products_collection}", description: '')]
                    echo "Product selected: ${products}"
                    dir('/app/JobRelease') {
                        version_collection = sh (script: 'awk \'/\'$products\'/{print $2}\' FS=: latest_release.txt', returnStdout: true).trim()
                    }
                        
                    versions = input message: 'Choose version!', ok: 'SET', parameters: [choice(name: 'VERSION', choices: "${version_collection}", description: '')]
                }
            }
        }


        stage("Deploy") {
            steps {
                script {
                    build(job: "Deployment",
                        parameters:
                        [string(name: 'Environment', value: "TEST"),
                        string(name: 'Product', value: "${products}"),
                        string(name: 'Version', value: "${versions}"),
                        ])
                }
            }
        }
    }
}
