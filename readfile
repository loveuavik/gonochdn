#!/usr/bin/env groovy

pipeline {
agent { label 'master'}
    stages {
        stage("choose version") {
            steps {
                script {
                    
                    def version_collection
                    def products_collection
                    
                    dir('/app/JobRelease') {
                         products_collection = sh (script: 'cat latest_release.txt |awk \'{print $1}\' FS=:', returnStdout: true).trim()
                    }
                    products = input message: 'Choose  Product!', ok: 'SET', parameters: [choice(name: 'PRODUCTS', choices: "${products_collection}", description: '')]
                    echo ${products}
                    dir('/app/JobRelease') {
                         version_collection = sh (script: 'cat latest_release.txt | grep ${products} |awk \'{print $2}\' FS=:', returnStdout: true).trim()
                    }
                        
                    versions = input message: 'Choose version!', ok: 'SET', parameters: [choice(name: 'VERSION', choices: "${version_collection}", description: '')]
                }
            }
        }


        stage("build") {
            steps {
                script {
                    build(job: "builder-job",
                        parameters:
                        [string(name: 'Nodes', value: "${products}"),
                        string(name: 'Versions', value: "${versions}"),
                        ])
                }
            }
        }
    }
}
