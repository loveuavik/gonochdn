#!/usr/bin/env groovy
import com.cwctravel.hudson.plugins.extended_choice_parameter.ExtendedChoiceParameterDefinition
import org.apache.commons.lang.StringUtils;

pipeline {
agent { label 'master'}
    parameters 
    {
                  choice(name: 'Deployment_Type', choices:"Latest\nAd-Hoc", description: "Select Deployment Type" )
                  choice(name: 'Source_Env', choices:"dev\ntest", description: "Select Source Environment" )
                  choice(name: 'Target_Env', choices:"test\nuat\nPre-Prod", description: "Select Target Environment" )
                  extendedChoice( 
                                    defaultValue: 'All', 
                                    description: 'Please select the service which you want to deploy', 
                                    multiSelectDelimiter: ':', 
                                    name: 'Services', 
                                    quoteValue: false, 
                                    saveJSONParameterToFile: false, 
                                    type: 'PT_CHECKBOX', 
                                    value:'smart-businesstax-discovery-inbound,smart-ttx-annualroll-outbound,smart-ttx-rollcorrection-outbound,All', 
                                    visibleItemCount: 4)
                  
                  string(defaultValue: "", description: 'What environment?', name: 'version')
    }
    stages 
    {
        stage("Checkout Code")
        {
            steps
            {
              checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'CleanBeforeCheckout']], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/loveuavik/jnkn.git']]])        
            }
        }
        stage("Select parameters and Deployment after that") 
        {
            steps 
            {
                script 
                { 
                    def product, version
                    println "Services : ${params.Services}"
                    if("${params.Deployment_Type}" == "Latest")
                    { 
                        def bodyFile = new File("${workspace}/release/${params.Source_Env}/latest_release.txt").readLines()
                        
                        bodyFile.each { line ->
                                         def arr = line.tokenize(':')
                                         product = arr[0]
                                         version = arr[1]
                                         println "product : ${product}  version: ${version}" 
                                         build(job: "Deployment",
                                                 parameters:
                                                 [string(name: 'Environment', value: "${params.Target_Env}"),
                                                 string(name: 'Product', value: "${product}"),
                                                 string(name: 'Version', value: "${version}"),
                                        ])
                                          
                        }
                              
                    }
                    else if("${params.Deployment_Type}" == "Ad-Hoc")
                    {
                        if (StringUtils.contains("${params.Services}", "All"))
                       {
                           def a = "${WORKSPACE}/release/${params.Source_Env}/RELEASE_${params.version}.txt"
                           def testFile = new File(a)
                           
                           if(testFile.exists())
                           {
                                  def bodyFile = new File("${WORKSPACE}/release/${params.Source_Env}/RELEASE_${params.version}.txt").readLines()
                        
                                  bodyFile.each { line ->
                                         def arr = line.tokenize(':')
                                         product = arr[0]
                                         version = arr[1]
                                      
                                         println "product : ${product}  version: ${version}" 
                                         
                                         build(job: "Deployment",
                                                    parameters:
                                                    [string(name: 'Environment', value: "${params.Target_Env}"),
                                                    string(name: 'Product', value: "${product}"),
                                                    string(name: 'Version', value: "${version}"),
                                          ])
                                         
                                          
                                  }
                           }
                           else 
                           {
                               error('could not find version file ${version}')
                           }
                              
                        }
                        else 
                        {
                            def a = "${WORKSPACE}/release/${params.Source_Env}/RELEASE_${params.version}.txt"
                            def testFile = new File(a)
                            
                            
                            if(testFile.exists())
                            {
                            
                                 def bodyFile = new File("${WORKSPACE}/release/${params.Source_Env}/RELEASE_${params.version}.txt").readLines()
                        
                                 bodyFile.each { line ->
                                                 def arr = line.tokenize(':')
                                                 product = arr[0]
                                                 version = arr[1]
                                         
                                                 if (StringUtils.contains("${params.Services}", "${product}"))
                                                 {
                                                      println "Service : ${product}  version: ${version}" 
                                         
                                                      build(job: "Deployment",
                                                            parameters:
                                                            [string(name: 'Environment', value: "${params.Target_Env}"),
                                                            string(name: 'Product', value: "${product}"),
                                                            string(name: 'Version', value: "${version}"),
                                                      ])
                                                  }
                                          
                                                }
                             }
                             else 
                             {
                                  error('could not find version file ${version}')
                             }
                        }
                      
                    }                  
                }
            }
        }
    }
}
